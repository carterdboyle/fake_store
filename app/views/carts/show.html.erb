<div class="flex flex-col grow">
  <h1 class="mb-6 text-2xl font-semibold">Your Cart</h1>

  <% if user_signed_in? %>
    <% if @cart&.cart_items&.any? %>
      <div class="overflow-x-auto rounded-xl border">
        <table class="min-w-full divide-y">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-3 text-left text-sm font-medium">Product</th>
              <th class="px-4 py-3 text-right text-sm font-medium">Price</th>
              <th class="px-4 py-3 text-center text-sm font-medium">Qty</th>
              <th class="px-4 py-3 text-right text-sm font-medium">Subtotal</th>
              <th class="px-4 py-3"></th>
            </tr>
          </thead>
          <tbody class="divide-y">
            <% @cart.cart_items.includes(:product).each do |item| %>
              <% p = item.product %>
              <% next unless p %>
              <tr>
                <td class="px-4 py-4">
                  <div class="font-medium"><%= p.title %></div>
                  <div class="text-sm text-gray-600"><%= truncate(p.description.to_s, length: 80) %></div>
                </td>
                <td class="px-4 py-4 text-right"><%= number_to_currency(p.price) %></td>
                <td class="px-4 py-4">
                  <div class="flex justify-center">
                    <%= form_with model: item, url: cart_item_path(item), method: :patch, class: "flex items-center gap-2" do |f| %>
                      <%= f.number_field :quantity,
                            value: item.quantity,
                            min: 1,
                            max: [99, p.amount.to_i].min,
                            class: "w-20 rounded border px-2 py-1 text-center" %>
                      <%= f.submit "Update", class: "rounded bg-blue-600 px-3 py-1.5 text-white hover:bg-blue-700" %>
                    <% end %>
                  </div>
                </td>
                <td class="px-4 py-4 text-right font-semibold">
                  <%= number_to_currency(p.price * item.quantity) %>
                </td>
                <td class="px-4 py-4 text-right">
                  <%= button_to "Remove", cart_item_path(item), method: :delete,
                        form: { data: { turbo_confirm: "Remove this item?" } },
                        class: "rounded bg-red-600 px-3 py-1.5 text-white hover:bg-red-700" %>
                </td>
              </tr>
            <% end %>
          </tbody>
          <tfoot class="bg-gray-50">
            <tr>
              <td colspan="3" class="px-4 py-4 text-right font-medium">Total</td>
              <td class="px-4 py-4 text-right font-bold">
                <%= number_to_currency(@cart.cart_items.includes(:product).sum { |ci| ci.product&.price.to_f * ci.quantity }) %>
              </td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>
      <div class="mt-6 flex justify-between">
        <div class="flex gap-10">
          <%= link_to "Continue shopping", products_path, class: "rounded border px-4 py-2 hover:bg-gray-50" %>
          <%= link_to "Destroy cart", cart_path, data: { turbo_confirm: "Are you sure?", turbo_method: :delete }, class: "border text-red-600 rounded border-red-600 px-4 py-2 hover:bg-red-600 hover:text-white "%>
        </div>
        <%# You can prompt sign in for checkout later %>
        <%= link_to "Checkout", checkout_path, data: { turbo_method: :post },
              class: "rounded bg-emerald-600 px-4 py-2 text-white hover:bg-emerald-700" %>
      </div>
    <% else %>
      <%= render partial: "empty" %>
    <% end %>

  <% else %> <%# -------- Guest (session) cart -------- %>
    <% if guest_cart.any? %>
      <% ids = guest_cart.keys.map(&:to_i) %>
      <% products = @guest_products || Product.where(id: ids).index_by(&:id) %>

      <div class="overflow-x-auto rounded-xl border">
        <table class="min-w-full divide-y">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-3 text-left text-sm font-medium">Product</th>
              <th class="px-4 py-3 text-right text-sm font-medium">Price</th>
              <th class="px-4 py-3 text-center text-sm font-medium">Qty</th>
              <th class="px-4 py-3 text-right text-sm font-medium">Subtotal</th>
              <th class="px-4 py-3"></th>
            </tr>
          </thead>
          <tbody class="divide-y">
            <% guest_cart.each do |pid, qty| %>
              <% p = products[pid.to_i] %>
              <% next unless p %>
              <% max = [99, p.amount.to_i].min %>
              <tr>
                <td class="px-4 py-4">
                  <div class="font-medium"><%= p.title %></div>
                  <div class="text-sm text-gray-600"><%= truncate(p.description.to_s, length: 80) %></div>
                </td>
                <td class="px-4 py-4 text-right"><%= number_to_currency(p.price) %></td>
                <td class="px-4 py-4">
                  <div class="flex justify-center">
                    <%# IMPORTANT: for guests we PUT/PATCH /cart_items/:id where :id is the product_id %>
                    <%= form_with url: cart_item_path(p.id), method: :patch, class: "flex items-center gap-2" do |f| %>
                      <%= f.number_field :quantity,
                            name: "cart_item[quantity]",
                            value: qty,
                            min: 1,
                            max: max,
                            class: "w-20 rounded border px-2 py-1 text-center" %>
                      <%= f.submit "Update", class: "rounded bg-blue-600 px-3 py-1.5 text-white hover:bg-blue-700" %>
                    <% end %>
                  </div>
                </td>
                <td class="px-4 py-4 text-right font-semibold">
                  <%= number_to_currency(p.price * qty.to_i) %>
                </td>
                <td class="px-4 py-4 text-right">
                  <%= button_to "Remove", cart_item_path(p.id), method: :delete,
                        form: { data: { turbo_confirm: "Remove this item?" } },
                        class: "rounded bg-red-600 px-3 py-1.5 text-white hover:bg-red-700" %>
                </td>
              </tr>
            <% end %>
          </tbody>
          <tfoot class="bg-gray-50">
            <tr>
              <td colspan="3" class="px-4 py-4 text-right font-medium">Total</td>
              <td class="px-4 py-4 text-right font-bold">
                <%= number_to_currency(
                      guest_cart.sum { |pid, qty| (products[pid.to_i]&.price.to_f || 0) * qty.to_i }
                    ) %>
              </td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="mt-6 flex justify-between">
        <div class="flex gap-10">
          <%= link_to "Continue shopping", products_path, class: "rounded border px-4 py-2 hover:bg-gray-50" %>
          <%= link_to "Destroy cart", cart_path, data: { turbo_confirm: "Are you sure?", turbo_method: :delete }, class: "border text-red-600 rounded border-red-600 px-4 py-2 hover:bg-red-600 hover:text-white "%>
        <div>
        <%= link_to "Sign in to checkout", new_user_session_path,
            class: "rounded bg-emerald-600 px-4 py-2 text-white hover:bg-emerald-700" %>
      </div>
    <% else %>
      <%= render partial: "empty" %>
    <% end %>
  <% end %>
</div>